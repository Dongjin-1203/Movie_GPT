## 1. 로컬 환경 실행 (Docker Compose)

### 1.1 사전 요구사항

실행 전 다음 소프트웨어가 설치되어 있어야 합니다:

| 소프트웨어 | 버전 | 다운로드 링크 |
|-----------|------|--------------|
| **Docker Desktop** | 24.x 이상 | https://www.docker.com/products/docker-desktop/ |
| **Git** | 최신 버전 | https://git-scm.com/downloads |
| **Visual Studio Code** | 최신 버전 (선택) | https://code.visualstudio.com/ |

**Docker 설치 확인:**
```bash
docker --version
# 출력 예시: Docker version 24.0.7

docker-compose --version
# 출력 예시: Docker Compose version v2.23.3
```

### 1.2 프로젝트 클론

```bash
# GitHub에서 프로젝트 클론
git clone https://github.com/[username]/Movie_GPT.git

# 프로젝트 디렉토리로 이동
cd Movie_GPT

# 파일 구조 확인
ls -la
# backend/  frontend/  docker-compose.yml  README.md
```

### 1.3 환경 변수 설정 (선택 사항)

Docker Compose 환경에서는 환경 변수가 \`docker-compose.yml\`에 이미 설정되어 있습니다. 필요시 비밀번호 등을 수정할 수 있습니다.

**docker-compose.yml 주요 환경 변수:**
```yaml
services:
  db:
    environment:
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: "0331"  # 원하는 비밀번호로 변경 가능
      POSTGRES_DB: Movie_DB

  backend:
    environment:
      DATABASE_URL: postgresql://postgres:0331@db:5432/Movie_DB
      # 비밀번호 변경 시 여기도 함께 수정

  frontend:
    environment:
      BASE_URL: http://backend:8000
```

**비밀번호 변경 예시:**
```yaml
# 1. db 서비스의 POSTGRES_PASSWORD 변경
POSTGRES_PASSWORD: "your_secure_password"

# 2. backend 서비스의 DATABASE_URL도 함께 변경
DATABASE_URL: postgresql://postgres:your_secure_password@db:5432/Movie_DB
```

#### 1.4 서비스 실행

**전체 스택 실행:**

```bash
# 모든 서비스를 빌드하고 실행 (최초 실행 시 5-10분 소요)
docker-compose up --build

# 또는 백그라운드 실행 (권장)
docker-compose up -d --build
```

**실행 로그 확인:**
```bash
# 전체 로그 확인
docker-compose logs -f

# 특정 서비스 로그만 확인
docker-compose logs -f backend
docker-compose logs -f frontend
docker-compose logs -f db
```

**성공적으로 실행되면 다음과 같은 로그가 출력됩니다:**
```
✅ db         | database system is ready to accept connections
✅ backend    | Uvicorn running on http://0.0.0.0:8000
✅ frontend   | You can now view your Streamlit app in your browser.
              | Local URL: http://0.0.0.0:8501
```

### 1.5 서비스 접속

모든 컨테이너가 정상 실행되면 브라우저에서 다음 URL로 접속합니다:

| 서비스 | URL | 설명 |
|--------|-----|------|
| **Frontend (웹 UI)** | http://localhost:8501 | Streamlit 메인 페이지 |
| **Backend API Docs** | http://localhost:8000/docs | FastAPI Swagger UI |
| **Backend ReDoc** | http://localhost:8000/redoc | FastAPI ReDoc (대안 문서) |
| **Backend Health** | http://localhost:8000/ | 헬스체크 엔드포인트 |

**접속 테스트:**
```bash
# Backend 헬스체크
curl http://localhost:8000/
# 출력: {"message":"Movie GPT API is running"}

# 영화 목록 조회 (빈 목록)
curl http://localhost:8000/movies/
# 출력: []
```

### 1.6 데이터베이스 접속 (선택 사항)

PostgreSQL 데이터베이스에 직접 접속하려면:

**방법 1: Docker 컨테이너 내부에서 접속**
```bash
# PostgreSQL 컨테이너 내부 접속
docker exec -it movie_gpt_db psql -U postgres -d Movie_DB

# SQL 쿼리 실행 예시
Movie_DB=# SELECT * FROM movies;
Movie_DB=# SELECT * FROM reviews;
Movie_DB=# \q  # 종료
```

**방법 2: 외부 클라이언트에서 접속**
- **Host**: localhost
- **Port**: 5432
- **Database**: Movie_DB
- **Username**: postgres
- **Password**: 0331 (또는 변경한 비밀번호)

**DBeaver, pgAdmin, DataGrip 등의 도구 사용 가능**

## 2. GCP 프로덕션 환경 배포

### 2.1 사전 요구사항

GCP 배포를 위해 다음이 필요합니다:

| 항목 | 요구사항 |
|------|----------|
| **GCP 계정** | https://cloud.google.com/ 에서 무료 계정 생성 |
| **결제 정보** | 신용카드 등록 (무료 크레딧 \$300 제공) |
| **gcloud CLI** | https://cloud.google.com/sdk/docs/install |
| **Git** | 코드 버전 관리 |

**gcloud CLI 설치 확인:**
```bash
gcloud --version
# 출력 예시: Google Cloud SDK 458.0.1
```

### 2.2 GCP 프로젝트 생성 및 인증

**1단계: gcloud 초기화**
```bash
# gcloud 초기화 (브라우저에서 로그인)
gcloud init

# 프롬프트 응답:
# - Re-initialize this configuration? [Y/n]: Y
# - Choose your account: [Google 계정 선택]
# - Create a new project: Y
# - Project ID: movie-gpt-project-[난수]  # 유니크한 ID 입력
# - Default region: 29 (asia-northeast3 - 서울)
```

**2단계: 프로젝트 설정 확인**
```bash
# 현재 프로젝트 확인
gcloud config get-value project

# 프로젝트 ID 저장
export PROJECT_ID=\$(gcloud config get-value project)
echo \$PROJECT_ID
```

**3단계: 필요한 API 활성화**
```bash
# Cloud Run, Cloud SQL, Artifact Registry 활성화
gcloud services enable run.googleapis.com
gcloud services enable sqladmin.googleapis.com
gcloud services enable cloudbuild.googleapis.com
gcloud services enable artifactregistry.googleapis.com

# 활성화 확인
gcloud services list --enabled
```

### 2.3 Cloud SQL 데이터베이스 생성

**1단계: PostgreSQL 인스턴스 생성**
```bash
# PostgreSQL 15 인스턴스 생성 (5-10분 소요)
gcloud sql instances create movie-gpt-db \
    --database-version=POSTGRES_15 \
    --tier=db-f1-micro \
    --region=asia-northeast3 \
    --root-password="YOUR_SECURE_PASSWORD"

# 비밀번호는 안전하게 보관하세요!
```

**2단계: 데이터베이스 생성**
```bash
# Movie_DB 데이터베이스 생성
gcloud sql databases create Movie_DB --instance=movie-gpt-db

# 생성 확인
gcloud sql databases list --instance=movie-gpt-db
```

**3단계: 연결 정보 확인**
```bash
# CONNECTION_NAME 확인 (⭐ 중요!)
gcloud sql instances describe movie-gpt-db \
    --format="value(connectionName)"

# 출력 예시: movie-gpt-project:asia-northeast3:movie-gpt-db
# 이 값을 메모하세요!
```

### 2.4 Artifact Registry 설정

**Docker 이미지를 저장할 저장소 생성:**

```bash
# Docker 저장소 생성
gcloud artifacts repositories create movie-gpt-repo \
    --repository-format=docker \
    --location=asia-northeast3 \
    --description="Movie GPT Docker images"

# Docker 인증 설정
gcloud auth configure-docker asia-northeast3-docker.pkg.dev

# 저장소 확인
gcloud artifacts repositories list
```

### 2.5 Backend 배포

**1단계: Docker 이미지 빌드 및 업로드**
```bash
# 프로젝트 루트 디렉토리에서
cd Movie_GPT

# Backend 이미지 빌드 (5-10분 소요)
gcloud builds submit ./backend \
    --tag asia-northeast3-docker.pkg.dev/\$PROJECT_ID/movie-gpt-repo/backend:latest \
    --timeout=20m

# 빌드 성공 확인
gcloud artifacts docker images list \
    asia-northeast3-docker.pkg.dev/\$PROJECT_ID/movie-gpt-repo
```

**2단계: Cloud Run에 배포**
```bash
# 환경 변수 설정
CONNECTION_NAME=\$(gcloud sql instances describe movie-gpt-db \
    --format="value(connectionName)")

DATABASE_URL="postgresql://postgres:YOUR_PASSWORD@/Movie_DB?host=/cloudsql/\${CONNECTION_NAME}"

# Backend 배포
gcloud run deploy movie-gpt-backend \
    --image asia-northeast3-docker.pkg.dev/\$PROJECT_ID/movie-gpt-repo/backend:latest \
    --platform managed \
    --region asia-northeast3 \
    --allow-unauthenticated \
    --add-cloudsql-instances \$CONNECTION_NAME \
    --set-env-vars DATABASE_URL="\$DATABASE_URL" \
    --memory 1Gi \
    --cpu 1 \
    --min-instances 0 \
    --max-instances 10 \
    --timeout 300

# 배포 성공 확인
gcloud run services describe movie-gpt-backend --region asia-northeast3
```

**3단계: Backend URL 확인**
```bash
# Backend URL 가져오기
BACKEND_URL=\$(gcloud run services describe movie-gpt-backend \
    --region asia-northeast3 \
    --format="value(status.url)")

echo "Backend URL: \$BACKEND_URL"
echo "API Docs: \$BACKEND_URL/docs"

# 브라우저에서 확인
# Linux/Mac: open \$BACKEND_URL/docs
# Windows: start \$BACKEND_URL/docs
```

### 2.6 Frontend 배포

**1단계: Frontend 이미지 빌드 및 업로드**
```bash
# Frontend 이미지 빌드 (3-5분 소요)
gcloud builds submit ./frontend \
    --tag asia-northeast3-docker.pkg.dev/\$PROJECT_ID/movie-gpt-repo/frontend:latest \
    --timeout=15m
```

**2단계: Cloud Run에 배포**
```bash
# Frontend 배포 (Backend URL 환경 변수로 전달)
gcloud run deploy movie-gpt-frontend \
    --image asia-northeast3-docker.pkg.dev/\$PROJECT_ID/movie-gpt-repo/frontend:latest \
    --platform managed \
    --region asia-northeast3 \
    --allow-unauthenticated \
    --set-env-vars BASE_URL="\$BACKEND_URL" \
    --memory 1Gi \
    --cpu 1 \
    --min-instances 0 \
    --max-instances 10 \
    --timeout 300

# 배포 성공 확인
gcloud run services describe movie-gpt-frontend --region asia-northeast3
```

**3단계: Frontend URL 확인**
```bash
# Frontend URL 가져오기
FRONTEND_URL=\$(gcloud run services describe movie-gpt-frontend \
    --region asia-northeast3 \
    --format="value(status.url)")

echo "=========================================="
echo "✅ 배포 완료!"
echo "=========================================="
echo "Frontend: \$FRONTEND_URL"
echo "Backend:  \$BACKEND_URL/docs"
echo "=========================================="

# 브라우저에서 확인
# Linux/Mac: open \$FRONTEND_URL
# Windows: start \$FRONTEND_URL
```
